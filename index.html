<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feuille de Garde - SDIS47</title>
    <style>
        :root {
            --color-red: #E31E24;
            --color-black: #000000;
            --color-gray-light: #f5f5f5;
            --color-gray: #626C71;
            --color-border: #ddd;
            --color-success: #21808D;
            --color-warning: #E68161;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-gray-light);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header {
            background: white;
            padding: 20px;
            border-bottom: 4px solid var(--color-red);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container img {
            height: 80px;
            width: auto;
        }

        .header-info {
            text-align: right;
        }

        .header-info h1 {
            font-size: 24px;
            color: var(--color-black);
            margin-bottom: 5px;
        }

        .header-info .date {
            font-size: 18px;
            color: var(--color-gray);
            font-weight: 500;
        }

        .info-bar {
            background: var(--color-red);
            color: white;
            padding: 12px 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .info-bar label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .info-bar input[type="date"],
        .info-bar input[type="text"] {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .info-bar input[type="text"] {
            width: 200px;
        }

        .agendis-links {
            display: flex;
            gap: 10px;
        }

        .agendis-links a,
        a[id="agendisToday"]:hover {
            background: #c41a1f;
        }

        .content {
            padding: 20px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            background: var(--color-black);
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-gray);
        }

        .form-group input,
        .form-group select {
            padding: 8px 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        thead {
            background: var(--color-gray-light);
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid var(--color-border);
            font-size: 14px;
        }

        th {
            font-weight: 600;
            color: var(--color-black);
        }

        td input,
        td select {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--color-border);
            border-radius: 3px;
            font-size: 13px;
        }

        td input[type="checkbox"] {
            width: auto;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-red);
            color: white;
        }

        .btn-primary:hover {
            background: #c41a1f;
        }

        .btn-secondary {
            background: var(--color-gray);
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5559;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
            margin-top: 10px;
        }

        .btn-success:hover {
            background: #1a6670;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }

        .status-ok {
            background: #d4edda;
        }

        .status-alert {
            background: #fff3cd;
        }

        .status-error {
            background: #f8d7da;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--color-border);
        }

            box-sizing: border-box;
        }

        @media print {
            body {
                padding: 0;
                background: white;
            }
            .container {
                box-shadow: none;
            }
            .info-bar {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .actions {
                display: none;
            }
            .agendis-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/b5dda112-aea7-413a-ac2c-cb7abd85e198" alt="SDIS47">
            </div>
            <div class="header-info">
                <h1>FEUILLE DE GARDE JOURNALI√àRE</h1>
                <div class="date" id="currentDate"></div>
            </div>
        </div>

        <div class="info-bar">
            <label>
                Date de garde :
                <input type="date" id="gardeDate" onchange="updateAgendisLinks()">
            </label>
        </div>

        <div class="content">
            <!-- Section Effectifs -->
            <div class="section">
                <div class="section-title">üë• EFFECTIFS DE GARDE</div>
                <div style="margin-bottom: 15px;">
                    <p style="font-size: 14px; color: var(--color-gray); margin-bottom: 10px;">
                        Consultez le planning des effectifs sur Agendis :
                    </p>
                    <a href="#" id="agendisToday" target="_blank" style="display: inline-block; background: var(--color-red); color: white; padding: 10px 20px; border-radius: 4px; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                        üìÖ Planning Agendis du jour
                    </a>
                </div>
            </div>

            <!-- Section Agent v√©rificateur -->
            <div class="section">
                <div class="section-title">‚úÖ AGENT V√âRIFICATEUR</div>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="openAgentVerificateurPopup()">‚ûï Ajouter un agent pour une v√©rification</button>
                </div>
                <table id="agentVerificateurTable">
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th>V√©hicule</th>
                            <th style="width: 80px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="agentVerificateurBody">
                    </tbody>
                </table>
            </div>

            <!-- Section Engins -->
            <div class="section">
                <div class="section-title">üöí √âTAT DES ENGINS</div>
                
                <!-- Sous-section VSAV -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--color-black); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--color-red);">VSAV</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 14px; font-weight: 500; color: var(--color-gray); display: block; margin-bottom: 8px;">
                            S√©lectionner un VSAV √† ajouter :
                        </label>
                        <select id="vsavSelect" style="padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px; width: 300px; margin-right: 10px;">
                            <option value="">-- Choisir un VSAV --</option>
                            <option value="VSAV 29">VSAV 29</option>
                            <option value="VSAV 49">VSAV 49</option>
                        </select>
                        <button class="btn btn-primary" onclick="addEngin('vsav')">‚ûï Ajouter l'engin</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="min-width: 1400px;">
                            <thead>
                                <tr>
                                    <th style="min-width: 80px;">Engin</th>
                                    <th style="min-width: 70px;">Carburant</th>
                                    <th style="min-width: 70px;">AdBlue</th>
                                    <th style="min-width: 80px;">Gyrophare</th>
                                    <th style="min-width: 80px;">√âclairage</th>
                                    <th style="min-width: 80px;">O2 Sac 5L</th>
                                    <th style="min-width: 80px;">O2 Cell1 5L</th>
                                    <th style="min-width: 80px;">O2 Cell2 5L</th>
                                    <th style="min-width: 80px;">O2 Cell 15L</th>
                                    <th style="min-width: 90px;">D√©tect. CO</th>
                                    <th style="min-width: 100px;">Multiparam.</th>
                                    <th style="min-width: 90px;">Aspirateur</th>
                                    <th style="min-width: 90px;">Thermo.</th>
                                    <th style="min-width: 90px;">Glyc√©mie</th>
                                    <th style="min-width: 120px;">Agent</th>
                                </tr>
                            </thead>
                            <tbody id="vsavBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sous-section VSR -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--color-black); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--color-red);">VSR</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 14px; font-weight: 500; color: var(--color-gray); display: block; margin-bottom: 8px;">
                            S√©lectionner un VSR √† ajouter :
                        </label>
                        <select id="vsrSelect" style="padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px; width: 300px; margin-right: 10px;">
                            <option value="">-- Choisir un VSR --</option>
                            <option value="VSRL 93">VSRL 93</option>
                        </select>
                        <button class="btn btn-primary" onclick="addEngin('vsr')">‚ûï Ajouter l'engin</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Engin</th>
                                <th>Observations</th>
                                <th style="width: 80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="vsrBody">
                        </tbody>
                    </table>
                </div>

                <!-- Sous-section FPT -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--color-black); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--color-red);">FPT</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 14px; font-weight: 500; color: var(--color-gray); display: block; margin-bottom: 8px;">
                            S√©lectionner un FPT √† ajouter :
                        </label>
                        <select id="fptSelect" style="padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px; width: 300px; margin-right: 10px;">
                            <option value="">-- Choisir un FPT --</option>
                            <option value="FPT 85">FPT 85</option>
                        </select>
                        <button class="btn btn-primary" onclick="addEngin('fpt')">‚ûï Ajouter l'engin</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Engin</th>
                                <th>Observations</th>
                                <th style="width: 80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="fptBody">
                        </tbody>
                    </table>
                </div>

                <!-- Sous-section UCCF -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--color-black); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--color-red);">UCCF</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 14px; font-weight: 500; color: var(--color-gray); display: block; margin-bottom: 8px;">
                            S√©lectionner un UCCF √† ajouter :
                        </label>
                        <select id="uccfSelect" style="padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px; width: 300px; margin-right: 10px;">
                            <option value="">-- Choisir un UCCF --</option>
                            <option value="UCCFM 74">UCCFM 74</option>
                            <option value="UCCFM 75">UCCFM 75</option>
                            <option value="UCCFS 98">UCCFS 98</option>
                            <option value="UCCFS 99">UCCFS 99</option>
                        </select>
                        <button class="btn btn-primary" onclick="addEngin('uccf')">‚ûï Ajouter l'engin</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Engin</th>
                                <th>Observations</th>
                                <th style="width: 80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="uccfBody">
                        </tbody>
                    </table>
                </div>

                <!-- Sous-section VL -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--color-black); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--color-red);">VL</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 14px; font-weight: 500; color: var(--color-gray); display: block; margin-bottom: 8px;">
                            S√©lectionner un VL √† ajouter :
                        </label>
                        <select id="vlSelect" style="padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px; width: 300px; margin-right: 10px;">
                            <option value="">-- Choisir un VL --</option>
                            <option value="VLRTT 38">VLRTT 38</option>
                            <option value="VLRTT 45">VLRTT 45</option>
                            <option value="VLRTT 76">VLRTT 76</option>
                            <option value="VLU 39">VLU 39</option>
                        </select>
                        <button class="btn btn-primary" onclick="addEngin('vl')">‚ûï Ajouter l'engin</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Engin</th>
                                <th>Observations</th>
                                <th style="width: 80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="vlBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section √âv√©nements -->
            <div class="section">
                <div class="section-title">üìã JOURNAL DES √âV√âNEMENTS</div>
                <table id="evenementsTable">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Heure</th>
                            <th style="width: 150px;">Type</th>
                            <th>√âv√©nement / Intervention</th>
                            <th style="width: 80px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="evenementsBody">
                        <tr>
                            <td><input type="time"></td>
                            <td>
                                <select>
                                    <option value="info">‚ÑπÔ∏è Information</option>
                                    <option value="intervention">üö® Intervention</option>
                                    <option value="exercice">üéØ Exercice</option>
                                    <option value="technique">üîß Technique</option>
                                </select>
                            </td>
                            <td><input type="text" placeholder="Description de l'√©v√©nement"></td>
                            <td><button class="btn btn-secondary" onclick="removeRow(this)">‚ùå</button></td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="addEvenement()">‚ûï Ajouter un √©v√©nement</button>
            </div>

            <!-- Section Observations -->
            <div class="section">
                <div class="section-title">üìù OBSERVATIONS ET CONSIGNES</div>
                <div class="grid">
                    <div class="form-group">
                        <label>Observations de la garde :</label>
                        <textarea id="observations" placeholder="Remarques g√©n√©rales, incidents, points d'attention..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Consignes pour la rel√®ve :</label>
                        <textarea id="consignes" placeholder="Informations importantes √† transmettre √† la prochaine garde..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button class="btn btn-success" onclick="window.print()">üñ®Ô∏è Imprimer la feuille de garde</button>
                <button class="btn btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
            </div>
        </div>
    </div>

    <script>
        // Syst√®me de sauvegarde automatique
        const STORAGE_KEY = 'sdis47_feuille_garde';
        
        // Sauvegarder les donn√©es
        function saveData() {
            const data = {
                date: document.getElementById('gardeDate').value,
                agentsVerificateurs: [],
                vsav: [],
                vsr: [],
                fpt: [],
                uccf: [],
                vl: [],
                evenements: [],
                observations: document.getElementById('observations').value,
                consignes: document.getElementById('consignes').value,
                lastUpdate: new Date().toISOString()
            };
            
            // Sauvegarder les agents v√©rificateurs
            const agentRows = document.getElementById('agentVerificateurBody').rows;
            for (let row of agentRows) {
                data.agentsVerificateurs.push({
                    agent: row.cells[0].textContent,
                    vehicule: row.cells[1].textContent
                });
            }
            
            // Sauvegarder les VSAV
            const vsavRows = document.getElementById('vsavBody').rows;
            for (let row of vsavRows) {
                data.vsav.push({
                    engin: row.cells[0].textContent,
                    carburant: row.cells[1].textContent,
                    adblue: row.cells[2].textContent,
                    gyrophare: row.cells[3].textContent,
                    eclairage: row.cells[4].textContent,
                    o2Sac: row.cells[5].textContent,
                    o2Cell1: row.cells[6].textContent,
                    o2Cell2: row.cells[7].textContent,
                    o2Cell15L: row.cells[8].textContent,
                    detecteurCO: row.cells[9].textContent,
                    multiparam: row.cells[10].textContent,
                    aspirateur: row.cells[11].textContent,
                    thermo: row.cells[12].textContent,
                    glycemie: row.cells[13].textContent,
                    agent: row.cells[14].textContent
                });
            }
            
            // Sauvegarder les autres engins (VSR, FPT, UCCF, VL)
            ['vsr', 'fpt', 'uccf', 'vl'].forEach(category => {
                const rows = document.getElementById(category + 'Body').rows;
                for (let row of rows) {
                    data[category].push({
                        engin: row.cells[0].textContent,
                        observations: row.cells[1].querySelector('input').value
                    });
                }
            });
            
            // Sauvegarder les √©v√©nements
            const eventRows = document.getElementById('evenementsBody').rows;
            for (let row of eventRows) {
                data.evenements.push({
                    heure: row.cells[0].querySelector('input').value,
                    type: row.cells[1].querySelector('select').value,
                    description: row.cells[2].querySelector('input').value
                });
            }
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            
            // Sauvegarder aussi dans Firebase si configur√©
            if (isFirebaseConfigured) {
                saveToFirebase(data);
            }
        }
        
        // Charger les donn√©es
        async function loadData() {
            const currentDate = document.getElementById('gardeDate').value;
            
            // Essayer de charger depuis Firebase d'abord
            if (isFirebaseConfigured) {
                const firebaseData = await loadFromFirebase(currentDate);
                if (firebaseData) {
                    console.log('üì• Donn√©es charg√©es depuis Firebase');
                    restoreData(firebaseData);
                    return;
                }
            }
            
            // Sinon charger depuis localStorage
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) return;
            
            try {
                const data = JSON.parse(savedData);
                restoreData(data);
            } catch (e) {
                console.error('Erreur lors du chargement des donn√©es:', e);
            }
        }
        
        // Fonction pour restaurer les donn√©es dans l'interface
        function restoreData(data) {
            try {
                
                // Restaurer la date
                if (data.date) {
                    document.getElementById('gardeDate').value = data.date;
                    updateAgendisLinks();
                }
                
                // Restaurer les agents v√©rificateurs
                const agentBody = document.getElementById('agentVerificateurBody');
                agentBody.innerHTML = '';
                data.agentsVerificateurs.forEach(item => {
                    const newRow = agentBody.insertRow();
                    newRow.innerHTML = `
                        <td>${item.agent}</td>
                        <td>${item.vehicule}</td>
                        <td><button class="btn btn-secondary" onclick="removeRow(this); saveData();">‚ùå</button></td>
                    `;
                });
                
                // Restaurer les VSAV
                const vsavBody = document.getElementById('vsavBody');
                vsavBody.innerHTML = '';
                data.vsav.forEach(item => {
                    const newRow = vsavBody.insertRow();
                    newRow.innerHTML = `
                        <td>${item.engin}</td>
                        <td>${item.carburant}</td>
                        <td>${item.adblue}</td>
                        <td>${item.gyrophare}</td>
                        <td>${item.eclairage}</td>
                        <td>${item.o2Sac}</td>
                        <td>${item.o2Cell1}</td>
                        <td>${item.o2Cell2}</td>
                        <td>${item.o2Cell15L}</td>
                        <td>${item.detecteurCO}</td>
                        <td>${item.multiparam}</td>
                        <td>${item.aspirateur}</td>
                        <td>${item.thermo}</td>
                        <td>${item.glycemie}</td>
                        <td>${item.agent}</td>
                    `;
                });
                
                // Restaurer les autres engins
                ['vsr', 'fpt', 'uccf', 'vl'].forEach(category => {
                    const tbody = document.getElementById(category + 'Body');
                    tbody.innerHTML = '';
                    if (data[category]) {
                        data[category].forEach(item => {
                            const newRow = tbody.insertRow();
                            newRow.innerHTML = `
                                <td><strong>${item.engin}</strong></td>
                                <td><input type="text" placeholder="Remarques" value="${item.observations}" onchange="saveData()"></td>
                            `;
                        });
                    }
                });
                
                // Restaurer les √©v√©nements
                const eventBody = document.getElementById('evenementsBody');
                eventBody.innerHTML = '';
                data.evenements.forEach(item => {
                    const newRow = eventBody.insertRow();
                    newRow.innerHTML = `
                        <td><input type="time" value="${item.heure}" onchange="saveData()"></td>
                        <td>
                            <select onchange="saveData()">
                                <option value="info" ${item.type === 'info' ? 'selected' : ''}>‚ÑπÔ∏è Information</option>
                                <option value="intervention" ${item.type === 'intervention' ? 'selected' : ''}>üö® Intervention</option>
                                <option value="exercice" ${item.type === 'exercice' ? 'selected' : ''}>üéØ Exercice</option>
                                <option value="technique" ${item.type === 'technique' ? 'selected' : ''}>üîß Technique</option>
                            </select>
                        </td>
                        <td><input type="text" placeholder="Description de l'√©v√©nement" value="${item.description}" onchange="saveData()"></td>
                        <td><button class="btn btn-secondary" onclick="removeRow(this); saveData();">‚ùå</button></td>
                    `;
                });
                
                // Restaurer les observations
                if (data.observations) document.getElementById('observations').value = data.observations;
                if (data.consignes) document.getElementById('consignes').value = data.consignes;
                
            } catch (e) {
                console.error('Erreur lors de la restauration des donn√©es:', e);
            }
        }
        
        // Initialisation de la date
        function initDate() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const currentDateElement = document.getElementById('currentDate');
            if (currentDateElement) {
                currentDateElement.textContent = dateStr;
            }
            
            const inputDate = today.toISOString().split('T')[0];
            const gardeDateElement = document.getElementById('gardeDate');
            if (gardeDateElement) {
                gardeDateElement.value = inputDate;
            }
            
            // Mise √† jour des liens Agendis sans sauvegarder
            updateAgendisLinks();
            
            // Charger les donn√©es existantes
            loadData();
        }

        // Mise √† jour des liens Agendis
        function updateAgendisLinks() {
            const dateInput = document.getElementById('gardeDate').value;
            if (!dateInput) return;
            
            const date = new Date(dateInput + 'T12:00:00');
            const formatDate = (d) => `${d.getFullYear()}_${d.getMonth() + 1}_${d.getDate()}`;
            
            const baseUrl = 'https://srv-agendis.sdis47.fr/Planification/Gardes/PlanningJournalier.aspx?c=37&d=';
            const agendisLink = document.getElementById('agendisToday');
            if (agendisLink) {
                agendisLink.href = baseUrl + formatDate(date);
            }
        }

        // Ajout d'un engin
        function addEngin(category) {
            const selectId = category + 'Select';
            const select = document.getElementById(selectId);
            const enginName = select.value;
            
            if (!enginName) {
                alert('Veuillez s√©lectionner un engin');
                return;
            }
            
            // Ouvrir la fen√™tre popup
            openEnginPopup(enginName, category);
            
            // R√©initialiser le select
            select.value = '';
        }

        // Ouvrir la popup pour saisir les informations de l'engin
        function openEnginPopup(enginName, category) {
            // Cr√©er l'overlay
            const overlay = document.createElement('div');
            overlay.id = 'popupOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            // Cr√©er la popup
            const popup = document.createElement('div');
            popup.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                max-width: 500px;
                width: 90%;
            `;
            
            // Contenu sp√©cifique pour VSAV
            const vsavContent = category === 'vsav' ? `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        Pression O2 bouteille 5L du sac (bars) :
                    </label>
                    <input type="number" id="popupO2Sac" min="0" placeholder="bars" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        Pression O2 bouteille 5L de la cellule 1 (bars) :
                    </label>
                    <input type="number" id="popupO2Cellule1" min="0" placeholder="bars" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        Pression O2 bouteille 5L de la cellule 2 (bars) :
                    </label>
                    <input type="number" id="popupO2Cellule2" min="0" placeholder="bars" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        Pression O2 bouteille 15L de la cellule (bars) :
                    </label>
                    <input type="number" id="popupO2Cellule15L" min="0" placeholder="bars" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        D√©tecteur CO :
                    </label>
                    <select id="popupDetecteurCO" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                        <option value="present">‚úÖ Pr√©sent</option>
                        <option value="absent">‚ùå Absent</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        Multiparam√®tres :
                    </label>
                    <select id="popupMultiparametres" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                        <option value="ok">‚úÖ OK</option>
                        <option value="nok">‚ùå NON OK</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        Aspirateur de mucosit√© :
                    </label>
                    <select id="popupAspirateur" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                        <option value="ok">‚úÖ OK</option>
                        <option value="nok">‚ùå NON OK</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        Thermom√®tre :
                    </label>
                    <select id="popupThermometre" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                        <option value="ok">‚úÖ OK</option>
                        <option value="nok">‚ùå NON OK</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                        Lecteur de glyc√©mie :
                    </label>
                    <select id="popupGlycemie" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                        <option value="ok">‚úÖ OK</option>
                        <option value="nok">‚ùå NON OK</option>
                    </select>
                </div>
            ` : '';
            
            popup.innerHTML = `
                <h2 style="margin: 0 0 20px 0; color: var(--color-black); font-size: 20px;">
                    V√©rification journali√®re - ${enginName}
                </h2>
                <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                            Niveau de carburant (%) :
                        </label>
                        <input type="number" id="popupCarburant" min="0" max="100" placeholder="%" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                            Niveau d'AdBlue (%) :
                        </label>
                        <input type="number" id="popupAdBlue" min="0" max="100" placeholder="%" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                            Gyrophare :
                        </label>
                        <select id="popupGyrophare" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                            <option value="ok">‚úÖ OK</option>
                            <option value="nok">‚ùå NON OK</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                            √âclairage :
                        </label>
                        <select id="popupEclairage" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                            <option value="ok">‚úÖ OK</option>
                            <option value="nok">‚ùå NON OK</option>
                        </select>
                    </div>
                    ${vsavContent}
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                            Observations :
                        </label>
                        <textarea id="popupObservations" placeholder="Remarques compl√©mentaires..." style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px; min-height: 80px; resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                            Nom de l'agent :
                        </label>
                        <input type="text" id="popupAgent" placeholder="Nom et pr√©nom de l'agent" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--color-border);">
                    <button class="btn btn-secondary" onclick="closeEnginPopup()">Annuler</button>
                    <button class="btn btn-primary" onclick="saveEnginFromPopup('${enginName}', '${category}')">Ajouter</button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
        }

        // Sauvegarder l'engin depuis la popup
        function saveEnginFromPopup(enginName, category) {
            const carburant = document.getElementById('popupCarburant').value;
            const adblue = document.getElementById('popupAdBlue').value;
            const gyrophare = document.getElementById('popupGyrophare').value;
            const eclairage = document.getElementById('popupEclairage').value;
            const observationsSupp = document.getElementById('popupObservations').value;
            const agent = document.getElementById('popupAgent').value;
            
            // Construire les observations √† partir des donn√©es
            let observations = [];
            if (carburant) observations.push(`Carburant: ${carburant}%`);
            if (adblue) observations.push(`AdBlue: ${adblue}%`);
            observations.push(`Gyro: ${gyrophare === 'ok' ? 'OK' : 'NON OK'}`);
            observations.push(`√âclairage: ${eclairage === 'ok' ? 'OK' : 'NON OK'}`);
            
            if (observationsSupp) observations.push(`Obs: ${observationsSupp}`);
            
            // Donn√©es sp√©cifiques VSAV
            if (category === 'vsav') {
                const o2Sac = document.getElementById('popupO2Sac').value;
                const o2Cellule1 = document.getElementById('popupO2Cellule1').value;
                const o2Cellule2 = document.getElementById('popupO2Cellule2').value;
                const o2Cellule15L = document.getElementById('popupO2Cellule15L').value;
                const detecteurCO = document.getElementById('popupDetecteurCO').value;
                const multiparametres = document.getElementById('popupMultiparametres').value;
                const aspirateur = document.getElementById('popupAspirateur').value;
                const thermometre = document.getElementById('popupThermometre').value;
                const glycemie = document.getElementById('popupGlycemie').value;
                
                if (o2Sac) observations.push(`O2 Sac 5L: ${o2Sac} bars`);
                if (o2Cellule1) observations.push(`O2 Cell.1 5L: ${o2Cellule1} bars`);
                if (o2Cellule2) observations.push(`O2 Cell.2 5L: ${o2Cellule2} bars`);
                if (o2Cellule15L) observations.push(`O2 Cell. 15L: ${o2Cellule15L} bars`);
                observations.push(`D√©tect.CO: ${detecteurCO === 'present' ? 'Pr√©sent' : 'Absent'}`);
                observations.push(`Multiparam: ${multiparametres === 'ok' ? 'OK' : 'NON OK'}`);
                observations.push(`Aspirateur: ${aspirateur === 'ok' ? 'OK' : 'NON OK'}`);
                observations.push(`Thermo: ${thermometre === 'ok' ? 'OK' : 'NON OK'}`);
                observations.push(`Glyc√©mie: ${glycemie === 'ok' ? 'OK' : 'NON OK'}`);
            }
            
            if (agent) observations.push(`Agent: ${agent}`);
            
            const tbodyId = category + 'Body';
            const tbody = document.getElementById(tbodyId);
            const newRow = tbody.insertRow();
            
            if (category === 'vsav') {
                const o2Sac = document.getElementById('popupO2Sac').value;
                const o2Cellule1 = document.getElementById('popupO2Cellule1').value;
                const o2Cellule2 = document.getElementById('popupO2Cellule2').value;
                const o2Cellule15L = document.getElementById('popupO2Cellule15L').value;
                const detecteurCO = document.getElementById('popupDetecteurCO').value;
                const multiparametres = document.getElementById('popupMultiparametres').value;
                const aspirateur = document.getElementById('popupAspirateur').value;
                const thermometre = document.getElementById('popupThermometre').value;
                const glycemie = document.getElementById('popupGlycemie').value;
                
                newRow.innerHTML = `
                    <td><strong>${enginName}</strong></td>
                    <td>${carburant ? carburant + '%' : '-'}</td>
                    <td>${adblue ? adblue + '%' : '-'}</td>
                    <td>${gyrophare === 'ok' ? '‚úÖ OK' : '‚ùå NON OK'}</td>
                    <td>${eclairage === 'ok' ? '‚úÖ OK' : '‚ùå NON OK'}</td>
                    <td>${o2Sac ? o2Sac + ' bars' : '-'}</td>
                    <td>${o2Cellule1 ? o2Cellule1 + ' bars' : '-'}</td>
                    <td>${o2Cellule2 ? o2Cellule2 + ' bars' : '-'}</td>
                    <td>${o2Cellule15L ? o2Cellule15L + ' bars' : '-'}</td>
                    <td>${detecteurCO === 'present' ? '‚úÖ Pr√©sent' : '‚ùå Absent'}</td>
                    <td>${multiparametres === 'ok' ? '‚úÖ OK' : '‚ùå NON OK'}</td>
                    <td>${aspirateur === 'ok' ? '‚úÖ OK' : '‚ùå NON OK'}</td>
                    <td>${thermometre === 'ok' ? '‚úÖ OK' : '‚ùå NON OK'}</td>
                    <td>${glycemie === 'ok' ? '‚úÖ OK' : '‚ùå NON OK'}</td>
                    <td>${agent || '-'}</td>
                `;
            } else {
                newRow.innerHTML = `
                    <td><strong>${enginName}</strong></td>
                    <td><input type="text" placeholder="Remarques" value="${observations.join(' | ')}"></td>
                `;
            }
            
            saveData();
            closeEnginPopup();
        }

        // Fermer la popup
        function closeEnginPopup() {
            const overlay = document.getElementById('popupOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Ouvrir la popup agent v√©rificateur
        function openAgentVerificateurPopup() {
            const overlay = document.createElement('div');
            overlay.id = 'popupOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const popup = document.createElement('div');
            popup.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                max-width: 500px;
                width: 90%;
            `;
            
            popup.innerHTML = `
                <h2 style="margin: 0 0 20px 0; color: var(--color-black); font-size: 20px;">
                    Ajouter un agent v√©rificateur
                </h2>
                <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                            V√©hicule :
                        </label>
                        <select id="popupVehicule" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                            <option value="">-- S√©lectionner un v√©hicule --</option>
                            <option value="VSAV 29">VSAV 29</option>
                            <option value="VSAV 49">VSAV 49</option>
                            <option value="VSRL 93">VSRL 93</option>
                            <option value="FPT 85">FPT 85</option>
                            <option value="UCCFM 74">UCCFM 74</option>
                            <option value="UCCFM 75">UCCFM 75</option>
                            <option value="UCCFS 98">UCCFS 98</option>
                            <option value="UCCFS 99">UCCFS 99</option>
                            <option value="VLRTT 38">VLRTT 38</option>
                            <option value="VLRTT 45">VLRTT 45</option>
                            <option value="VLRTT 76">VLRTT 76</option>
                            <option value="VLU 39">VLU 39</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-gray);">
                            Agent (Pr√©nom et Nom) :
                        </label>
                        <input type="text" id="popupAgentVerif" placeholder="Pr√©nom et nom de l'agent" style="width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 14px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--color-border);">
                    <button class="btn btn-secondary" onclick="closeAgentVerificateurPopup()">Annuler</button>
                    <button class="btn btn-primary" onclick="saveAgentVerificateur()">Ajouter</button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
        }

        // Fermer la popup agent v√©rificateur
        function closeAgentVerificateurPopup() {
            const overlay = document.getElementById('popupOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Sauvegarder l'agent v√©rificateur
        function saveAgentVerificateur() {
            const vehicule = document.getElementById('popupVehicule').value;
            const agent = document.getElementById('popupAgentVerif').value;
            
            if (!vehicule || !agent) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            const tbody = document.getElementById('agentVerificateurBody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td>${agent}</td>
                <td>${vehicule}</td>
                <td><button class="btn btn-secondary" onclick="removeRow(this); saveData();">‚ùå</button></td>
            `;
            
            saveData();
            closeAgentVerificateurPopup();
        }

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBCY1ns4SPRqZ2qtRHhekSp9UsAH17h9is",
            authDomain: "sdis47-garde.firebaseapp.com",
            databaseURL: "https://sdis47-garde-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "sdis47-garde",
            storageBucket: "sdis47-garde.firebasestorage.app",
            messagingSenderId: "36803710300",
            appId: "1:36803710300:web:558dca60c10f7a9a0fc599"
        };

        // Initialiser Firebase (sera fait apr√®s configuration)
        let db = null;
        let isFirebaseConfigured = true;

        // V√©rifier si Firebase est configur√©
        function checkFirebaseConfig() {
            return firebaseConfig.apiKey !== "VOTRE_API_KEY";
        }

        // Sauvegarder dans Firebase
        function saveToFirebase(data) {
            if (!window.db) {
                return;
            }
            
            const dateKey = data.date.replace(/-/g, '_');
            const dataRef = window.dbRef(window.db, 'feuilles_garde/' + dateKey);
            window.dbSet(dataRef, data)
                .then(() => {
                    console.log('‚úÖ Donn√©es sauvegard√©es dans Firebase');
                })
                .catch((error) => {
                    console.error('‚ùå Erreur Firebase:', error);
                    alert('Erreur lors de la sauvegarde en ligne. Donn√©es sauvegard√©es localement.');
                });
        }

        // Charger depuis Firebase
        function loadFromFirebase(date) {
            if (!window.isFirebaseConfigured || !window.db) {
                return Promise.resolve(null);
            }
            
            const dateKey = date.replace(/-/g, '_');
            const dbRef = window.dbRef(window.db);
            return window.dbGet(window.dbChild(dbRef, 'feuilles_garde/' + dateKey))
                .then((snapshot) => {
                    return snapshot.val();
                })
                .catch((error) => {
                    console.error('‚ùå Erreur chargement Firebase:', error);
                    return null;
                });
        }

        // Ajout d'un √©v√©nement
        function addEvenement() {
            const tbody = document.getElementById('evenementsBody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="time" onchange="saveData()"></td>
                <td>
                    <select onchange="saveData()">
                        <option value="info">‚ÑπÔ∏è Information</option>
                        <option value="intervention">üö® Intervention</option>
                        <option value="exercice">üéØ Exercice</option>
                        <option value="technique">üîß Technique</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Description de l'√©v√©nement" onchange="saveData()"></td>
                <td><button class="btn btn-secondary" onclick="removeRow(this); saveData();">‚ùå</button></td>
            `;
            saveData();
        }

        // Suppression d'une ligne
        function removeRow(button) {
            const row = button.parentElement.parentElement;
            const tbody = row.parentElement;
            row.remove();
            
            // Renum√©roter les effectifs si n√©cessaire
            if (tbody.id === 'effectifsBody') {
                const rows = tbody.rows;
                for (let i = 0; i < rows.length; i++) {
                    rows[i].cells[0].textContent = i + 1;
                }
                updateEffectifCount();
            }
        }

        // Mise √† jour du statut visuel d'une ligne d'engin
        function updateRowStatus(select) {
            const row = select.parentElement.parentElement;
            row.className = '';
            
            if (select.value === 'ok') {
                row.classList.add('status-ok');
            } else if (select.value === 'alert') {
                row.classList.add('status-alert');
            } else if (select.value === 'error') {
                row.classList.add('status-error');
            }
        }

        // R√©initialisation du formulaire
        function resetForm() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser la feuille de garde ?')) {
                location.reload();
            }
        }

        // Initialisation au chargement
        window.onload = function() {
            // V√©rifier si Firebase est configur√©
            isFirebaseConfigured = checkFirebaseConfig();
            
            if (isFirebaseConfigured) {
                console.log('‚úÖ Firebase configur√©, chargement du SDK...');
            } else {
                console.log('‚ö†Ô∏è Firebase non configur√©. Instructions dans la console.');
                console.log('%cüìã GUIDE DE CONFIGURATION FIREBASE', 'color: #E31E24; font-size: 16px; font-weight: bold;');
                console.log('%c1. Cr√©ez un projet gratuit sur https://console.firebase.google.com', 'color: #21808D; font-size: 14px;');
                console.log('%c2. Activez "Realtime Database" dans votre projet', 'color: #21808D; font-size: 14px;');
                console.log('%c3. Copiez votre configuration Firebase', 'color: #21808D; font-size: 14px;');
                console.log('%c4. Remplacez les valeurs dans firebaseConfig au d√©but du script', 'color: #21808D; font-size: 14px;');
                console.log('%c5. Rechargez la page', 'color: #21808D; font-size: 14px;');
                console.log('%c\nüí° En attendant, l\'application fonctionne en mode local', 'color: #626C71; font-size: 13px;');
            }
            
            initDate();
        };
    </script>
    
    <!-- Firebase SDK v9+ (modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, get, child } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        
        // Initialiser Firebase apr√®s chargement des SDK
        if (isFirebaseConfigured) {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getDatabase(app);
                window.dbRef = ref;
                window.dbSet = set;
                window.dbGet = get;
                window.dbChild = child;
                console.log('‚úÖ Firebase initialis√© avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur initialisation Firebase:', error);
                window.isFirebaseConfigured = false;
            }
        }
    </script>
</body>
</html>
